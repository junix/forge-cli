# ADR-002: Reasoning Event Handling in Command Line Tools

## Status
Accepted

## Context
When using the hello-file-search.py command, reasoning/thinking tokens were being generated by the model but not displayed in the UI. This caused the command line to appear frozen while the model was thinking, providing a poor user experience.

Investigation revealed that reasoning events come through a different event structure than initially expected.

## Decision
We will handle reasoning events through multiple event types to support different API formats:

1. **Primary Format**: Handle `response.output_item.added` events where `item.type == "reasoning"`
   - Extract text from `item.summary[].text`
   - Display in real-time as thinking process

2. **Alternative Format**: Keep handlers for `response.reasoning_summary_text.delta` events
   - Some models may use this format
   - Provides backward compatibility

3. **Debug Tools**: Create debug-event-logger.py to help identify event structures
   - Logs all events with timestamps
   - Shows event data structure
   - Helps diagnose reasoning event issues

## Implementation Details

### Event Structure (Primary Format)
```json
{
  "type": "response.output_item.added",
  "item": {
    "type": "reasoning",
    "id": "reason-xxx",
    "summary": [
      {
        "type": "summary_text",
        "text": "The thinking process text..."
      }
    ],
    "status": "in_progress"
  }
}
```

### Display Strategy
- Show reasoning with "ðŸ¤” Thinking:" prefix
- Use yellow color for reasoning text
- Clear transition between thinking and response phases
- Support both Rich and plain terminal display

## Consequences

### Positive
- **Better UX**: Users see thinking process in real-time
- **Transparency**: Clear visibility into AI reasoning
- **Flexibility**: Supports multiple event formats
- **Debugging**: Event logger helps diagnose issues

### Negative
- **Complexity**: Must handle multiple event formats
- **Maintenance**: Need to track API changes in event structure

## Lessons Learned

1. **Event Structure Varies**: Different models/APIs may use different event structures
2. **Debug First**: Create debugging tools before implementing features
3. **Flexible Handlers**: Design event handlers to accommodate multiple formats
4. **User Feedback**: Visual feedback during long operations is critical

## References
- Original issue: Reasoning tokens not displayed during streaming
- Debug output showing actual event structure
- Knowledge Forge Response API documentation